<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .chatbot-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1400px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            padding: 24px;
            color: white;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .agent-avatar {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .header-text h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .header-text p {
            opacity: 0.9;
            font-size: 14px;
        }

        .chat-messages {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.5;
            animation: slideIn 0.3s ease-out;
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.agent {
            align-self: flex-start;
            background: #f8fafc;
            color: #334155;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 6px;
        }

        .progress-container {
            margin: 24px 0;
            padding: 24px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
        }

        .progress-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .agent-pulse {
            width: 24px;
            height: 24px;
            background: #4f46e5;
            border-radius: 50%;
            position: relative;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .agent-pulse::before,
        .agent-pulse::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: #4f46e5;
            opacity: 0.3;
            animation: pulse-ring 1.5s ease-in-out infinite;
        }

        .agent-pulse::after {
            animation-delay: 0.5s;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 0.3; }
            100% { transform: scale(2); opacity: 0; }
        }

        .progress-steps {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
            background: white;
            color: #64748b;
        }

        .step-circle.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .step-circle.completed {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .step-connector {
            flex: 1;
            height: 2px;
            background: #e2e8f0;
            transition: background 0.3s ease;
        }

        .step-connector.completed {
            background: #10b981;
        }

        .step-details {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e2e8f0;
            margin-top: 12px;
        }

        .step-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-description {
            color: #64748b;
            font-size: 14px;
            line-height: 1.5;
        }

        .step-stats {
            background: #f1f5f9;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 13px;
            color: #475569;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .stat-item:last-child {
            margin-bottom: 0;
        }

        .stat-value {
            font-weight: 600;
            color: #1e293b;
        }

        .thinking-animation {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }

        .thinking-dot {
            width: 6px;
            height: 6px;
            background: #4f46e5;
            border-radius: 50%;
            animation: thinking 1.4s ease-in-out infinite both;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }
        .thinking-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes thinking {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chat-input {
            padding: 24px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-container {
            flex: 1;
            position: relative;
        }

        .input-field {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 24px;
            font-size: 15px;
            resize: none;
            outline: none;
            transition: all 0.3s ease;
            font-family: inherit;
            line-height: 1.5;
            max-height: 120px;
        }

        .input-field:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .send-button {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .download-section {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 16px;
            color: white;
            text-align: center;
        }

        .download-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            font-weight: 600;
        }

        .download-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .completion-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        @media (max-width: 768px) {
            .chatbot-container {
                height: 100vh;
                border-radius: 0;
                max-width: none;
            }
            
            .progress-steps {
                flex-wrap: wrap;
                gap: 12px;
            }
            
            .step-connector {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="chatbot-container">
        <div class="chat-header">
            <div class="agent-avatar">🤖</div>
            <div class="header-text">
                <h1>AI News Assistant</h1>
                <p>Enter any topic and watch me curate personalized news with AI intelligence</p>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="message agent">
                <strong>Welcome to AI News Assistant!</strong><br>
                I'm your intelligent news curation AI. Simply enter any topic you're interested in, and I'll analyze it through advanced AI processes to deliver personalized news recommendations. You'll see exactly how my AI algorithms work, then receive a comprehensive Excel report with curated news for your interests.
            </div>
        </div>

        <div class="chat-input">
            <div class="input-container">
                <textarea class="input-field" id="userInput" placeholder="Enter a topic you want news about (e.g., artificial intelligence, climate change, sports...)"></textarea>
            </div>
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                ➤
            </button>
        </div>
    </div>

    <script>
        const steps = [
            {
                title: "🤖 AI Topic Analysis",
                description: "AI algorithms analyze your topic to understand context, relevance, and identify key categories for news curation."
            },
            {
                title: "👥 User Preference Matching", 
                description: "Intelligent matching system finds users with similar interests and analyzes preference patterns for personalization."
            },
            {
                title: "📰 AI News Filtering",
                description: "Advanced AI filters through thousands of news articles to find the most relevant content for your topic."
            },
            {
                title: "🔍 Duplicate Detection AI",
                description: "Smart deduplication algorithms remove similar content and identify unique, valuable news pieces."
            },
            {
                title: "⚡ Personalization Engine",
                description: "AI personalization engine creates custom news feeds tailored to individual user preferences and reading patterns."
            },
            {
                title: "📊 News Delivery Report",
                description: "Final AI compilation generates comprehensive news delivery recommendations with priority scoring and timing."
            }
        ];

        let currentStep = 0;
        let isProcessing = false;
        let currentTopic = '';

        async function testBackendConnection() {
            try {
                console.log('🔍 Testing backend connection...');
                const response = await fetch(`${window.location.origin}/api/health`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Backend connection successful:', data);
                    addMessage(`
                        <strong>✅ AI News System Ready!</strong><br>
                        Backend connection established successfully. AI News Delivery System is operational with ${data.databases?.users || 0} users, ${data.databases?.news_tags || 0} news tags, and ${data.databases?.news_articles || 0} articles in database.
                    `);
                } else {
                    throw new Error(`Health check failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Backend connection failed:', error);
                addMessage(`
                    <strong>Backend Connection Issue</strong><br>
                    Cannot connect to Python Flask server. Please ensure:<br>
                    - Flask server is running: <code>python app.py</code><br>
                    - Server is accessible at: <code>${window.location.origin}</code><br>
                    - No firewall blocking port 5000<br><br>
                    Error: ${error.message}
                `);
            }
        }

        window.addEventListener('load', testBackendConnection);

        document.getElementById('userInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });

        document.getElementById('userInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'agent'}`;
            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function createProgressContainer() {
            return `
                <div class="progress-container">
                    <div class="progress-header">
                        <div class="agent-pulse"></div>
                        <strong>AI News Processing Engine</strong>
                        <div class="thinking-animation">
                            <div class="thinking-dot"></div>
                            <div class="thinking-dot"></div>
                            <div class="thinking-dot"></div>
                        </div>
                    </div>
                    <div class="progress-steps" id="progressSteps">
                        ${steps.map((step, index) => `
                            <div class="step-circle" id="step${index}" data-step="${index}">
                                ${index + 1}
                            </div>
                            ${index < steps.length - 1 ? '<div class="step-connector" id="connector' + index + '"></div>' : ''}
                        `).join('')}
                    </div>
                    <div class="step-details" id="stepDetails">
                        <div class="step-title">Ready to begin AI processing...</div>
                        <div class="step-description">Waiting for your topic to start the intelligent news analysis.</div>
                    </div>
                </div>
            `;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message || isProcessing) return;

            isProcessing = true;
            currentTopic = message;
            document.getElementById('sendButton').disabled = true;
            
            addMessage(message, true);
            input.value = '';
            input.style.height = 'auto';

            addMessage(`
                <strong>Perfect! I'll analyze "${message}" through my AI news curation workflow.</strong><br>
                Watch as my AI algorithms process your topic with full transparency:
                ${createProgressContainer()}
            `);

            await processSteps(message);
        }

        async function processSteps(topic) {
            for (let i = 0; i < steps.length; i++) {
                await processStep(i, topic);
                await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1500));
            }
            
            await completeProcess(topic);
        }

        async function processStep(stepIndex, topic) {
            currentStep = stepIndex;
            const step = steps[stepIndex];
            
            const stepCircle = document.getElementById(`step${stepIndex}`);
            const stepDetails = document.getElementById('stepDetails');
            
            stepCircle.classList.add('active');
            
            stepDetails.innerHTML = `
                <div class="step-title">
                    ${step.title}
                    <div class="thinking-animation">
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                    </div>
                </div>
                <div class="step-description">${step.description}</div>
            `;

            try {
                const response = await fetch('/api/process-step', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        step: stepIndex,
                        topic: topic
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    stepCircle.classList.remove('active');
                    stepCircle.classList.add('completed');
                    stepCircle.innerHTML = '✓';
                    
                    if (stepIndex < steps.length - 1) {
                        const connector = document.getElementById(`connector${stepIndex}`);
                        connector.classList.add('completed');
                    }

                    const stepData = result.result.data;
                    const statsHtml = createStatsHTML(stepData, stepIndex);
                    
                    stepDetails.innerHTML = `
                        <div class="step-title">
                            ${step.title}
                            <span class="completion-badge">COMPLETED</span>
                        </div>
                        <div class="step-description">
                            <strong>✅ ${result.result.message}</strong><br>
                            ${result.result.details}
                        </div>
                        ${statsHtml}
                    `;
                } else {
                    throw new Error(result.error || 'Step processing failed');
                }
            } catch (error) {
                console.error(`Error in step ${stepIndex + 1}:`, error);
                await processStepMock(stepIndex, stepCircle, stepDetails, step);
            }
        }

        function createStatsHTML(stepData, stepIndex) {
            let statsHtml = '<div class="step-stats">';
            
            switch(stepIndex) {
                case 0:
                    if (stepData.relevant_categories) {
                        statsHtml += `
                            <div class="stat-item"><span>Categories Found:</span> <span class="stat-value">${stepData.relevant_categories.length}</span></div>
                            <div class="stat-item"><span>Classification Accuracy:</span> <span class="stat-value">${stepData.classification_accuracy}</span></div>
                            <div class="stat-item"><span>Processing Time:</span> <span class="stat-value">${stepData.ai_processing_time}</span></div>
                        `;
                    }
                    break;
                case 1:
                    if (stepData.matching_users) {
                        statsHtml += `
                            <div class="stat-item"><span>Users Analyzed:</span> <span class="stat-value">${stepData.total_users_analyzed}</span></div>
                            <div class="stat-item"><span>Matches Found:</span> <span class="stat-value">${stepData.matching_users.length}</span></div>
                            <div class="stat-item"><span>Match Rate:</span> <span class="stat-value">${stepData.match_rate}</span></div>
                            <div class="stat-item"><span>Avg Relevance:</span> <span class="stat-value">${stepData.avg_relevance}</span></div>
                        `;
                    }
                    break;
                case 2: 
                    if (stepData.filtered_articles) {
                        statsHtml += `
                            <div class="stat-item"><span>Articles Processed:</span> <span class="stat-value">${stepData.total_articles_processed}</span></div>
                            <div class="stat-item"><span>Relevant Articles:</span> <span class="stat-value">${stepData.articles_after_filtering}</span></div>
                            <div class="stat-item"><span>Filter Efficiency:</span> <span class="stat-value">${stepData.ai_filtering_efficiency}</span></div>
                            <div class="stat-item"><span>Avg Relevance:</span> <span class="stat-value">${stepData.avg_relevance_score}</span></div>
                        `;
                    }
                    break;
                case 3:
                    if (stepData.unique_articles) {
                        statsHtml += `
                            <div class="stat-item"><span>Articles Before:</span> <span class="stat-value">${stepData.original_count}</span></div>
                            <div class="stat-item"><span>Duplicates Removed:</span> <span class="stat-value">${stepData.original_count - stepData.final_count}</span></div>
                            <div class="stat-item"><span>Unique Articles:</span> <span class="stat-value">${stepData.final_count}</span></div>
                            <div class="stat-item"><span>AI Accuracy:</span> <span class="stat-value">${stepData.ai_processing_accuracy}</span></div>
                        `;
                    }
                    break;
                case 4:
                    if (stepData.personalized_feeds) {
                        statsHtml += `
                            <div class="stat-item"><span>Users Served:</span> <span class="stat-value">${stepData.total_users_served}</span></div>
                            <div class="stat-item"><span>Avg Articles/User:</span> <span class="stat-value">${stepData.avg_articles_per_user}</span></div>
                            <div class="stat-item"><span>AI Accuracy:</span> <span class="stat-value">${stepData.ai_personalization_accuracy}</span></div>
                            <div class="stat-item"><span>Processing Time:</span> <span class="stat-value">${stepData.processing_time}</span></div>
                        `;
                    }
                    break;
                case 5:
                    if (stepData.delivery_report) {
                        statsHtml += `
                            <div class="stat-item"><span>Total Recommendations:</span> <span class="stat-value">${stepData.total_recommendations}</span></div>
                            <div class="stat-item"><span>Users Served:</span> <span class="stat-value">${stepData.users_served}</span></div>
                            <div class="stat-item"><span>Avg Relevance:</span> <span class="stat-value">${stepData.avg_relevance_score}</span></div>
                            <div class="stat-item"><span>Status:</span> <span class="stat-value">Ready for Download</span></div>
                        `;
                    }
                    break;
            }
            
            statsHtml += '</div>';
            return statsHtml;
        }

        async function processStepMock(stepIndex, stepCircle, stepDetails, step) {
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            stepCircle.classList.remove('active');
            stepCircle.classList.add('completed');
            stepCircle.innerHTML = '✓';
            
            if (stepIndex < steps.length - 1) {
                const connector = document.getElementById(`connector${stepIndex}`);
                connector.classList.add('completed');
            }

            const mockResults = [
                "AI analyzed topic successfully - 3 categories identified with 89% confidence",
                "User matching complete - 8 users found with relevant interests",
                "News filtering successful - 156 relevant articles from 2,500 processed",
                "Duplicate detection complete - 23 duplicates removed, 133 unique articles remain",
                "Personalization engine complete - Custom feeds created for 5 users",
                "Final report generated - 89 personalized recommendations ready"
            ];
            
            stepDetails.innerHTML = `
                <div class="step-title">
                    ${step.title}
                    <span class="completion-badge">COMPLETED</span>
                </div>
                <div class="step-description">
                    <strong>✅ Step completed successfully!</strong><br>
                    ${mockResults[stepIndex]}
                </div>
            `;
        }

        async function completeProcess(topic) {
            const stepDetails = document.getElementById('stepDetails');
            
            const thinkingAnimation = document.querySelector('.thinking-animation');
            if (thinkingAnimation) {
                thinkingAnimation.style.display = 'none';
            }

            const agentPulse = document.querySelector('.agent-pulse'); if (agentPulse) { agentPulse.style.display = 'none'; }
            
            stepDetails.innerHTML = `
                <div class="step-title">
                    🎉 AI Processing Complete!
                </div>
                <div class="step-description">
                    Your personalized news analysis for "<strong>${topic}</strong>" is ready for download.
                </div>
                <div class="download-section">
                    <strong>📰 Your AI News Report is Ready!</strong><br>
                    <a href="#" class="download-button" onclick="downloadReport('${topic}')">
                        📥 Download Excel Report
                    </a>
                </div>
            `;

            addMessage(`
                <strong>🎊 AI News Curation Complete!</strong><br><br>
                I've successfully processed "<strong>${topic}</strong>" through my intelligent news AI pipeline. Here's what my algorithms accomplished:<br><br>
                ✅ <strong>Topic Analysis:</strong> AI identified relevant news categories<br>
                ✅ <strong>User Matching:</strong> Found users with similar interests<br>
                ✅ <strong>News Filtering:</strong> AI filtered thousands of articles for relevance<br>
                ✅ <strong>Duplicate Detection:</strong> Smart algorithms removed redundant content<br>
                ✅ <strong>Personalization:</strong> Created custom news feeds for each user<br>
                ✅ <strong>Report Generation:</strong> Compiled comprehensive delivery recommendations<br><br>
                Your detailed Excel report with AI-curated news is now ready for download! 🚀
            `);

            isProcessing = false;
            document.getElementById('sendButton').disabled = false;
        }

        function downloadReport(topic) {
            console.log('📥 Requesting Excel report from Python backend...');
            
            fetch('/api/download-report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    topic: topic
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const byteCharacters = atob(result.file_data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: result.mime_type });
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = result.filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    addMessage(`
                        <strong>📥 Download Completed!</strong><br>
                        Your AI-curated news report for "<strong>${topic}</strong>" has been generated and downloaded successfully!<br><br>
                        <strong>📊 Report Contents:</strong><br>
                        • File: ${result.filename}<br>
                        • Generated: ${new Date().toLocaleString()}<br>
                        • Contains: Personalized news recommendations, user preferences, AI scores<br>
                        • Source: AI News Delivery Engine<br><br>
                        Ready for your next news topic analysis!
                    `);
                } else {
                    throw new Error(result.error || 'Failed to generate report');
                }
            })
            .catch(error => {
                console.error('Download error:', error);
                addMessage(`
                    <strong>Download Error</strong><br>
                    Could not generate Excel report: ${error.message}<br>
                    Please ensure the Python backend server is running.
                `);
            });
        }
    </script>
</body>
</html>